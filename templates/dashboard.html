<!DOCTYPE html>
<html>
<head>
    <title>Dashboard - Policy Pulse AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/chart.js') }}"></script>
</head>

<body class="dashboard-body">

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
    <h2>Policy Pulse</h2>

    <a href="/dashboard">Dashboard</a>
    <a href="/upload-policy">Upload Policy</a>
    <a href="/scheme-advisor">Scheme Advisor</a>
    <a href="/logout">Logout</a>

    <button class="collapse-btn" onclick="toggleSidebar()">☰</button>
</div>

<!-- MAIN CONTENT -->
<div class="main-content" id="mainContent">

    <!-- PREMIUM TOP HEADER -->
    <div class="top-header">
        <div class="top-left">
            <h1>AI Policy Dashboard</h1>
        </div>

        <div class="top-right">
            <div id="liveTime" class="live-time"></div>
            <div class="policy-count">
                {{ total_policies }} Policies Analyzed
            </div>
        </div>
    </div>

    <!-- METRICS -->
    <div class="metrics-grid">

        <div class="metric-card">
            <h3>Total Policies</h3>
            <div class="metric-value" id="totalCount">{{ total_policies }}</div>
        </div>

        <div class="metric-card">
            <h3>Average Impact</h3>
            <div class="metric-value">{{ average_impact }}/100</div>
        </div>

        <div class="metric-card">
            <h3>Top Keyword</h3>
            <div class="metric-value">
                {% if top_keywords %}
                    {{ top_keywords[0][0] }}
                {% else %}
                    -
                {% endif %}
            </div>
        </div>

    </div>

    <!-- CHART SECTION -->
    <div class="charts-grid">

        <!-- Sentiment Chart -->
        <div class="chart-container">
            <h3>Sentiment Distribution</h3>
            <div class="chart-wrapper">
                <canvas id="sentimentChart"></canvas>
            </div>
        </div>

        <!-- Impact Trend Chart -->
        <div class="chart-container">
            <h3>Impact Trend</h3>
            <div class="chart-wrapper">
                <canvas id="impactChart"></canvas>
            </div>
        </div>

    </div>

    <!-- RECENT POLICIES -->
    <h3 class="section-title">Recent Policies</h3>

    {% for policy in policies %}
        <div class="policy-card" onclick="togglePolicy(this)">
            <h4>{{ policy[0] }}</h4>

            <div class="policy-content">
                <p>{{ policy[1] }}</p>
                <small>Sentiment: {{ policy[3] }}</small>
            </div>
        </div>
    {% endfor %}

    <!-- FOOTER -->
    <div class="dashboard-footer">
        © 2026 Policy Pulse AI · Built by Priyanshu Gajghate
    </div>

</div>

<!-- FLOATING BUTTON -->
<a href="/upload-policy" class="fab">+</a>

<script>

/* Sidebar Collapse */
function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    const main = document.getElementById("mainContent");

    sidebar.classList.toggle("collapsed");
    main.classList.toggle("expanded");
}

/* Expand Policy Card */
function togglePolicy(card) {
    const content = card.querySelector('.policy-content');
    content.style.display =
        content.style.display === "block" ? "none" : "block";
}

/* Animated Counter */
let count = document.getElementById("totalCount");
let target = parseInt(count.innerText);
let current = 0;

let interval = setInterval(() => {
    if(current >= target){
        clearInterval(interval);
    } else {
        current++;
        count.innerText = current;
    }
}, 25);

/* Live Time */
function updateTime() {
    const now = new Date();
    document.getElementById("liveTime").innerText =
        now.toLocaleDateString() + " " + now.toLocaleTimeString();
}
setInterval(updateTime, 1000);
updateTime();

/* Sentiment Chart */
const ctx = document.getElementById('sentimentChart');

new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: {{ sentiment_counts.keys()|list|tojson }},
        datasets: [{
            data: {{ sentiment_counts.values()|list|tojson }},
            backgroundColor: ['#0ea5e9','#f87171','#34d399','#fbbf24','#a78bfa']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});

/* Impact Trend Chart (lightweight dummy progression based on impact) */
const impactCtx = document.getElementById('impactChart');

new Chart(impactCtx, {
    type: 'line',
    data: {
        labels: {{ sentiment_counts.keys()|list|tojson }},
        datasets: [{
            label: "Impact Trend",
            data: {{ sentiment_counts.values()|list|tojson }},
            borderColor: "#0ea5e9",
            backgroundColor: "rgba(14,165,233,0.1)",
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});

</script>

</body>
</html>